# 学生管理系统 — 部署说明

## 一、文档说明

本文档用于说明学生管理系统的部署流程与配置方法，包括开发环境搭建、生产环境部署及常见问题处理，为项目部署提供完整的操作指南。

---

## 二、环境要求

### 2.1 服务器要求

| 项目 | 最低配置 | 推荐配置 |
| ---- | -------- | -------- |
| CPU | 1 核 | 2 核及以上 |
| 内存 | 2GB | 4GB 及以上 |
| 硬盘 | 20GB | 50GB 及以上 |
| 操作系统 | Linux / Windows | Linux（Ubuntu 20.04+） |

### 2.2 软件环境

| 软件 | 版本要求 | 说明 |
| ---- | -------- | ---- |
| Node.js | 22.x | 后端运行环境 |
| npm | 10.x | 包管理工具 |
| MySQL | 8.x | 数据库 |
| Nginx | 1.18+ | 反向代理（生产环境） |
| Git | 2.x | 版本控制 |

---

## 三、开发环境搭建

### 3.1 安装 Node.js

**Windows / macOS：**

1. 访问 [Node.js 官网](https://nodejs.org/)
2. 下载 LTS 版本安装包
3. 运行安装程序，按提示完成安装

**Linux（Ubuntu）：**

```bash
# 使用 NodeSource 安装
curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node -v
npm -v
```

### 3.2 安装 MySQL

**Windows：**

1. 访问 [MySQL 官网](https://dev.mysql.com/downloads/)
2. 下载 MySQL Installer
3. 运行安装程序，选择 Developer Default 安装类型
4. 设置 root 密码

**Linux（Ubuntu）：**

```bash
# 安装 MySQL
sudo apt update
sudo apt install mysql-server

# 启动 MySQL 服务
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置
sudo mysql_secure_installation

# 登录 MySQL
sudo mysql -u root -p
```

### 3.3 克隆项目代码

```bash
# 克隆项目
git clone https://github.com/your-repo/student-management-system.git

# 进入项目目录
cd student-management-system
```

### 3.4 后端项目配置

```bash
# 进入后端目录
cd backend

# 安装依赖
npm install

# 复制配置文件
cp .env.example .env

# 编辑配置文件
vim .env
```

**.env 配置文件示例：**

```env
# 服务配置
PORT=3000
NODE_ENV=development

# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=student_management

# JWT 配置
JWT_SECRET=your_jwt_secret_key
JWT_EXPIRES_IN=7d

# 邮件配置（可选）
MAIL_HOST=smtp.example.com
MAIL_PORT=465
MAIL_USER=your_email@example.com
MAIL_PASS=your_email_password
```

### 3.5 初始化数据库

```bash
# 登录 MySQL
mysql -u root -p

# 创建数据库
CREATE DATABASE student_management CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;

# 退出 MySQL
exit

# 执行初始化脚本
mysql -u root -p student_management < database/init.sql
```

### 3.6 启动后端服务

```bash
# 开发模式启动
npm run dev

# 服务启动成功后访问
# http://localhost:3000
```

### 3.7 前端项目配置

```bash
# 进入前端目录
cd ../frontend

# 安装依赖
npm install

# 复制配置文件
cp .env.example .env.local

# 编辑配置文件
vim .env.local
```

**.env.local 配置文件示例：**

```env
# API 地址
VITE_API_BASE_URL=http://localhost:3000/api/v1
```

### 3.8 启动前端服务

```bash
# 开发模式启动
npm run dev

# 服务启动成功后访问
# http://localhost:5173
```

---

## 四、生产环境部署

### 4.1 服务器准备

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装必要工具
sudo apt install -y curl wget git vim
```

### 4.2 安装 Node.js（生产环境）

```bash
# 安装 Node.js
curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装 PM2（进程管理）
sudo npm install -g pm2
```

### 4.3 安装 MySQL（生产环境）

```bash
# 安装 MySQL
sudo apt install -y mysql-server

# 安全配置
sudo mysql_secure_installation

# 创建数据库和用户
sudo mysql -u root -p
```

```sql
-- 创建数据库
CREATE DATABASE student_management CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;

-- 创建专用用户
CREATE USER 'sms_user'@'localhost' IDENTIFIED BY 'your_secure_password';

-- 授权
GRANT ALL PRIVILEGES ON student_management.* TO 'sms_user'@'localhost';
FLUSH PRIVILEGES;

-- 退出
exit
```

### 4.4 安装 Nginx

```bash
# 安装 Nginx
sudo apt install -y nginx

# 启动 Nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 4.5 部署后端服务

```bash
# 克隆项目
cd /var/www
sudo git clone https://github.com/your-repo/student-management-system.git
sudo chown -R $USER:$USER student-management-system

# 进入后端目录
cd student-management-system/backend

# 安装依赖
npm install --production

# 配置环境变量
cp .env.example .env
vim .env
```

**生产环境 .env 配置：**

```env
# 服务配置
PORT=3000
NODE_ENV=production

# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=sms_user
DB_PASSWORD=your_secure_password
DB_NAME=student_management

# JWT 配置
JWT_SECRET=your_production_jwt_secret_key
JWT_EXPIRES_IN=7d
```

```bash
# 初始化数据库
mysql -u sms_user -p student_management < database/init.sql

# 使用 PM2 启动服务
pm2 start npm --name "sms-backend" -- start

# 设置开机自启
pm2 startup
pm2 save
```

### 4.6 部署前端服务

```bash
# 进入前端目录
cd /var/www/student-management-system/frontend

# 安装依赖
npm install

# 配置环境变量
cp .env.example .env.production
vim .env.production
```

**生产环境 .env.production 配置：**

```env
VITE_API_BASE_URL=/api/v1
```

```bash
# 构建生产版本
npm run build

# 构建产物在 dist 目录
ls dist/
```

### 4.7 配置 Nginx

```bash
# 创建 Nginx 配置文件
sudo vim /etc/nginx/sites-available/student-management
```

**Nginx 配置文件内容：**

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 前端静态文件
    root /var/www/student-management-system/frontend/dist;
    index index.html;

    # 前端路由
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API 反向代理
    location /api {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
```

```bash
# 启用配置
sudo ln -s /etc/nginx/sites-available/student-management /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重载 Nginx
sudo systemctl reload nginx
```

### 4.8 配置 HTTPS（可选）

```bash
# 安装 Certbot
sudo apt install -y certbot python3-certbot-nginx

# 获取 SSL 证书
sudo certbot --nginx -d your-domain.com

# 自动续期测试
sudo certbot renew --dry-run
```

---

## 五、Docker 部署（可选）

### 5.1 安装 Docker

```bash
# 安装 Docker
curl -fsSL https://get.docker.com | sh

# 安装 Docker Compose
sudo apt install -y docker-compose

# 启动 Docker
sudo systemctl start docker
sudo systemctl enable docker
```

### 5.2 Docker Compose 配置

**docker-compose.yml：**

```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: sms-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: student_management
      MYSQL_USER: sms_user
      MYSQL_PASSWORD: user_password
    volumes:
      - mysql_data:/var/lib/mysql
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3306:3306"

  backend:
    build: ./backend
    container_name: sms-backend
    restart: always
    environment:
      NODE_ENV: production
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: sms_user
      DB_PASSWORD: user_password
      DB_NAME: student_management
      JWT_SECRET: your_jwt_secret
    ports:
      - "3000:3000"
    depends_on:
      - mysql

  frontend:
    build: ./frontend
    container_name: sms-frontend
    restart: always
    ports:
      - "80:80"
    depends_on:
      - backend

volumes:
  mysql_data:
```

### 5.3 启动 Docker 服务

```bash
# 构建并启动
docker-compose up -d --build

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

---

## 六、运维管理

### 6.1 服务管理命令

```bash
# PM2 常用命令
pm2 list                    # 查看服务列表
pm2 logs sms-backend        # 查看日志
pm2 restart sms-backend     # 重启服务
pm2 stop sms-backend        # 停止服务
pm2 delete sms-backend      # 删除服务

# Nginx 常用命令
sudo systemctl status nginx   # 查看状态
sudo systemctl reload nginx   # 重载配置
sudo systemctl restart nginx  # 重启服务

# MySQL 常用命令
sudo systemctl status mysql   # 查看状态
sudo systemctl restart mysql  # 重启服务
```

### 6.2 日志管理

```bash
# 后端日志位置
~/.pm2/logs/sms-backend-out.log
~/.pm2/logs/sms-backend-error.log

# Nginx 日志位置
/var/log/nginx/access.log
/var/log/nginx/error.log

# MySQL 日志位置
/var/log/mysql/error.log
```

### 6.3 数据库备份

```bash
# 手动备份
mysqldump -u sms_user -p student_management > backup_$(date +%Y%m%d).sql

# 定时备份（添加到 crontab）
crontab -e
# 添加以下内容（每天凌晨 2 点备份）
0 2 * * * mysqldump -u sms_user -p'password' student_management > /backup/sms_$(date +\%Y\%m\%d).sql
```

---

## 七、常见问题

### 7.1 端口被占用

```bash
# 查看端口占用
sudo lsof -i :3000
sudo netstat -tlnp | grep 3000

# 结束占用进程
sudo kill -9 <PID>
```

### 7.2 数据库连接失败

1. 检查 MySQL 服务是否启动
2. 检查数据库用户名和密码是否正确
3. 检查数据库是否存在
4. 检查防火墙是否放行端口

### 7.3 Nginx 502 错误

1. 检查后端服务是否正常运行
2. 检查 Nginx 代理配置是否正确
3. 查看 Nginx 错误日志

### 7.4 前端页面空白

1. 检查前端构建是否成功
2. 检查 Nginx 静态文件路径配置
3. 检查浏览器控制台错误信息

---

## 八、安全建议

### 8.1 服务器安全

- 定期更新系统和软件包
- 配置防火墙，仅开放必要端口
- 禁用 root 远程登录
- 使用 SSH 密钥认证

### 8.2 应用安全

- 使用 HTTPS 加密传输
- 定期更换 JWT 密钥
- 数据库密码使用强密码
- 定期备份数据

### 8.3 防火墙配置

```bash
# UFW 防火墙配置
sudo ufw allow 22      # SSH
sudo ufw allow 80      # HTTP
sudo ufw allow 443     # HTTPS
sudo ufw enable
```

---

## 九、总结

本部署说明文档涵盖了学生管理系统从开发环境到生产环境的完整部署流程，包括传统部署和 Docker 部署两种方式。部署过程中请根据实际情况调整配置参数，并注意安全防护措施。